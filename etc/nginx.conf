events {}

http {
    # Use Docker embedded DNS to resolve service names at runtime
    resolver 127.0.0.11 valid=30s;

    client_header_buffer_size 16k;
    large_client_header_buffers 4 16k;

    server {
        listen 80;

        location / {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            # Pass authentication headers to upstream
            auth_request_set $access_token $upstream_http_x_auth_request_access_token;

            proxy_set_header Authorization "Bearer $access_token";

            # defer DNS resolution until request time
            set $backend "dcache:2880";
            proxy_pass http://$backend;
        }


        location /whoami/ {
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/sign_in;

            # Pass authentication headers to upstream
            auth_request_set $access_token $upstream_http_x_auth_request_access_token;

            proxy_set_header Authorization "Bearer $access_token";

            # defer DNS resolution until request time
            set $backend "whoami:80";
            proxy_pass http://$backend;
        }

        location /oauth2/ {
            # route oauth2-proxy requests (use service name from compose)
            set $oauth_backend "oauth2-proxy:4180";
            proxy_pass http://$oauth_backend;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Scheme $scheme;
            proxy_set_header X-Auth-Request-Redirect $request_uri;
        }
    }
}